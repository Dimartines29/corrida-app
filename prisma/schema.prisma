generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id            String     @id @default(cuid())
  email         String     @unique
  password      String?
  role          Role       @default(USER)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  emailVerified DateTime?
  image         String?
  name          String?
  resetToken         String?    @unique
  resetTokenExpiry   DateTime?
  accounts      Account[]
  inscricao     Inscricao?
  sessions      Session[]
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Lote {
  id         String      @id @default(cuid())
  nome       String
  preco      Float
  dataInicio DateTime
  dataFim    DateTime
  ativo      Boolean     @default(true)
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt
  inscricoes Inscricao[]
}

model Inscricao {
  id                 String          @id @default(cuid())
  codigo             Int             @unique
  userId             String          @unique
  categoria          String
  loteId             String
  nomeCompleto       String
  cpf                String          @unique
  rg                 String
  dataNascimento     DateTime
  sexo               String
  telefone           String
  endereco           String
  bairro             String
  cidade             String
  estado             String
  cep                String
  tamanhoCamisa      String
  retiradaKit        String
  possuiPlanoSaude   Boolean
  contatoEmergencia  String
  telefoneEmergencia String
  declaracaoSaude    Boolean
  valorPago          Float
  kitretirado        Boolean         @default(false)
  cupomId            String?
  cupom              Cupom?          @relation(fields: [cupomId], references: [id])
  valorDesconto      Float           @default(0) // Quanto foi descontado
  status             StatusInscricao @default(PENDENTE)
  valeAlmoco         Boolean         @default(false)
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt
  lote               Lote            @relation(fields: [loteId], references: [id])
  user               User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  pagamento          Pagamento?
}

model Cupom {
  id              String         @id @default(cuid())
  codigo          String         @unique // "PRIMEIRACOMPRA", "DESCONTO10"
  desconto        Float          // Valor do desconto (10 para 10% ou 20 para R$20)
  tipoDesconto    TipoDesconto   // PERCENTUAL ou FIXO
  origem          String         // "Parceiro X", "Influencer Y", "Marketing"
  ativo           Boolean        @default(true)
  dataInicio      DateTime       @default(now())
  dataValidade    DateTime
  usoMaximo       Int?           // null = ilimitado
  usoPorUsuario   Int?           @default(1) // null = ilimitado
  valorMinimo     Float?         // Valor mínimo da inscrição para aplicar
  totalUsos       Int            @default(0) // Contador automático

  // Relacionamento
  inscricoes      Inscricao[]

  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([codigo])
  @@index([ativo])
}

// Adicione este enum no seu schema.prisma
enum TipoDesconto {
  PERCENTUAL  // Ex: 10 = 10% de desconto
  FIXO        // Ex: 20 = R$ 20,00 de desconto
}

model Pagamento {
  id              String          @id @default(cuid())
  inscricaoId     String          @unique
  transacaoId     String          @unique
  valor           Float
  status          StatusPagamento @default(PENDENTE)
  metodoPagamento String
  deviceId        String?
  createdAt       DateTime        @default(now())
  updatedAt       DateTime        @updatedAt
  inscricao       Inscricao       @relation(fields: [inscricaoId], references: [id], onDelete: Cascade)
}

model ConfiguracaoSite {
  id                String   @id @default(cuid())
  nomeEvento        String
  dataEvento        DateTime
  localEvento       String
  descricao         String
  regulamento       String
  inscricoesAbertas Boolean  @default(true)
  updatedAt         DateTime @updatedAt
}

enum Role {
  USER
  ADMIN
}

enum StatusInscricao {
  PENDENTE
  PAGO
  CANCELADO
}

enum StatusPagamento {
  PENDENTE
  APROVADO
  RECUSADO
  REEMBOLSADO
}
